# P03_데이터_구조_및_정책

## 데이터 구조 개요

### 카카오톡 알림톡 정책 데이터
`data/policies/` 디렉토리에 저장된 정책 문서들이 AI 템플릿 생성의 핵심 데이터 소스

## 정책 문서 분석

### 1. 심사 가이드라인 (audit.md)
**목적**: 템플릿 승인을 위한 심사 기준과 절차
- 템플릿 승인 프로세스
- 심사 기준 및 체크리스트
- 거부 사유 및 재신청 절차
- 승인 소요 시간 가이드

### 2. 금지 콘텐츠 (black-list.md)
**목적**: 절대 사용할 수 없는 콘텐츠 및 표현
- 법적 제재 대상 콘텐츠
- 스팸성 표현
- 오해의 소지가 있는 문구
- 부적절한 마케팅 문구

### 3. 콘텐츠 작성 가이드 (content-guide.md)
**목적**: 올바른 템플릿 작성을 위한 상세 가이드라인
- 메시지 구조 및 형식
- 글자 수 제한 (1,000자)
- 변수 사용법 `#{변수명}`
- 개행 및 특수문자 사용 규칙

### 4. 이미지 사용 정책 (image.md)
**목적**: 알림톡 내 이미지 사용에 대한 규정
- 이미지 규격 및 크기 제한
- 허용/금지 이미지 유형
- 이미지와 텍스트의 연관성 요구사항
- 저작권 및 초상권 주의사항

### 5. 정보성 메시지 (infotalk.md)
**목적**: 정보 전달 목적의 알림톡 정책
- 정보성 vs 광고성 메시지 구분 기준
- 정보성 메시지 작성 원칙
- 허용되는 정보 유형
- 광고 요소 포함 시 주의사항

### 6. 운영 가이드라인 (operations.md)
**목적**: 알림톡 서비스 운영 시 준수사항
- 발송 빈도 제한
- 수신자 동의 확인 절차
- 수신 거부 처리 방법
- 개인정보 보호 준수사항

### 7. 공용 템플릿 (publictemplate.md)
**목적**: 사전 승인된 공용 템플릿 활용 가이드
- 공용 템플릿 카테고리
- 변수 치환 규칙
- 공용 템플릿 커스터마이징 한계
- 업종별 적용 가능한 템플릿

### 8. 허용 콘텐츠 (white-list.md)
**목적**: 적극 권장되는 콘텐츠 및 표현
- 모범 사례 표현
- 고객 친화적 문구
- 법적 안정성이 검증된 표현
- 업종별 권장 문구

## 데이터베이스 스키마

### 템플릿 관련 테이블

#### templates
```sql
CREATE TABLE templates (
    id INT PRIMARY KEY AUTO_INCREMENT,
    user_id VARCHAR(255) NOT NULL,
    template_name VARCHAR(255) NOT NULL,
    content TEXT NOT NULL,
    category VARCHAR(100),
    business_type VARCHAR(100),
    template_type ENUM('info', 'ad', 'mixed') DEFAULT 'info',
    status ENUM('draft', 'pending', 'approved', 'rejected') DEFAULT 'draft',
    approval_date DATETIME NULL,
    rejection_reason TEXT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_user_id (user_id),
    INDEX idx_status (status),
    INDEX idx_category (category)
);
```

#### template_variables
```sql
CREATE TABLE template_variables (
    id INT PRIMARY KEY AUTO_INCREMENT,
    template_id INT NOT NULL,
    variable_name VARCHAR(100) NOT NULL,
    variable_type VARCHAR(50) NOT NULL,
    is_required BOOLEAN DEFAULT FALSE,
    default_value VARCHAR(255) NULL,
    description TEXT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (template_id) REFERENCES templates(id) ON DELETE CASCADE,
    UNIQUE KEY unique_template_variable (template_id, variable_name)
);
```

### 정책 검증 테이블

#### policy_violations
```sql
CREATE TABLE policy_violations (
    id INT PRIMARY KEY AUTO_INCREMENT,
    template_id INT NOT NULL,
    violation_type VARCHAR(100) NOT NULL,
    policy_reference VARCHAR(100) NOT NULL,
    violation_content TEXT NOT NULL,
    severity ENUM('low', 'medium', 'high', 'critical') NOT NULL,
    auto_detected BOOLEAN DEFAULT TRUE,
    resolved BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    resolved_at DATETIME NULL,
    FOREIGN KEY (template_id) REFERENCES templates(id) ON DELETE CASCADE,
    INDEX idx_template_id (template_id),
    INDEX idx_severity (severity)
);
```

#### policy_checks
```sql
CREATE TABLE policy_checks (
    id INT PRIMARY KEY AUTO_INCREMENT,
    template_id INT NOT NULL,
    check_type VARCHAR(100) NOT NULL,
    check_result ENUM('pass', 'warning', 'fail') NOT NULL,
    details JSON NULL,
    checked_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (template_id) REFERENCES templates(id) ON DELETE CASCADE,
    INDEX idx_template_id (template_id),
    INDEX idx_check_result (check_result)
);
```

### 사용자 및 비즈니스 테이블

#### users
```sql
CREATE TABLE users (
    id VARCHAR(255) PRIMARY KEY,
    business_name VARCHAR(255) NOT NULL,
    business_type VARCHAR(100) NOT NULL,
    business_number VARCHAR(20) UNIQUE,
    contact_email VARCHAR(255) NOT NULL,
    contact_phone VARCHAR(20),
    is_verified BOOLEAN DEFAULT FALSE,
    subscription_tier ENUM('free', 'basic', 'premium') DEFAULT 'free',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_business_type (business_type),
    INDEX idx_subscription_tier (subscription_tier)
);
```

#### business_categories
```sql
CREATE TABLE business_categories (
    id INT PRIMARY KEY AUTO_INCREMENT,
    category_name VARCHAR(100) NOT NULL UNIQUE,
    parent_category_id INT NULL,
    description TEXT,
    special_requirements JSON NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (parent_category_id) REFERENCES business_categories(id)
);
```

## 벡터 데이터베이스 (Chroma)

### 정책 문서 임베딩
```python
# 정책 문서 청킹 전략
CHUNK_SIZE = 500  # 토큰 단위
CHUNK_OVERLAP = 50  # 중복 토큰 수

# 컬렉션 구조
collections = {
    'policy_guidelines': {
        'description': '정책 가이드라인 임베딩',
        'metadata_fields': ['policy_type', 'severity', 'category']
    },
    'template_examples': {
        'description': '승인된 템플릿 예시',
        'metadata_fields': ['business_type', 'template_type', 'approval_date']
    },
    'violation_patterns': {
        'description': '위반 패턴 및 사례',
        'metadata_fields': ['violation_type', 'severity', 'frequency']
    }
}
```

### 메타데이터 구조
```python
# 정책 문서 메타데이터
policy_metadata = {
    'source_file': 'content-guide.md',
    'policy_type': 'content_guidelines',
    'section': 'character_limits',
    'importance': 'high',
    'last_updated': '2024-01-15'
}

# 템플릿 메타데이터
template_metadata = {
    'business_type': 'restaurant',
    'template_type': 'reservation_confirmation',
    'approval_status': 'approved',
    'usage_frequency': 'high',
    'success_rate': 0.95
}
```

## 데이터 흐름

### 1. 정책 데이터 처리 파이프라인
```
정책 문서 (.md) → 텍스트 파싱 → 청킹 → 임베딩 → 벡터DB 저장
```

### 2. 템플릿 생성 프로세스
```
사용자 입력 → 정책 검색 → LLM 생성 → 정책 검증 → 결과 반환
```

### 3. 실시간 정책 검증
```
템플릿 텍스트 → 다중 정책 체크 → 위반 사항 식별 → 개선 제안
```

## 성능 고려사항

### 인덱싱 전략
- 템플릿 검색을 위한 full-text 인덱스
- 사용자별 템플릿 조회 최적화
- 정책 위반 유형별 인덱싱

### 캐싱 전략
- 자주 사용되는 정책 가이드라인 캐싱
- 승인된 템플릿 패턴 캐싱
- 사용자별 선호 설정 캐싱

### 백업 및 복구
- 일일 자동 백업 스케줄
- 정책 문서 버전 관리
- 사용자 템플릿 이력 보존